label "Constellation"
title "Constellation Viewer"

accesslevel link

storage page
# Would like to be in std mode for readonly access
setmode edit

field size {
	editmode hidden
	default 384
}

field modem {
	editmode hidden
	default 1
}

display {
	# Create tabs for all modulations
	set activetab 0
	set tablist {}
	set count 0

	set size [cgi get size]
	set num [cgi get samples]

	cgi tabs -level 2 [expr {[cgi get modem] - 1}] [list [cgi href $page modem 1] "Modem 1"  [cgi href $page modem 2] "Modem 2"]

	set imagesize $size
	html tag img src=[cgi href constimage modem [cgi get modem] modn auto size $size num $num] width=$imagesize height=$imagesize
}

field mode {
	label "Mode"
	type {enum 0 1}
	editmode {select 0 "Sampled Mode" 1 "Burst Mode}
	default 0
	storage none
	display {
		if {[cgi auth access $page ro]} {
			cgi addattrs disabled
		}
		cgi set $field [readfile [root]/supervisory/modem[cgi get modem]/const_mode]
		# display_field_help
	}
	help "Sampling mode for constellation data"
}

field source {
	label "Source"
	type {enum 0 1 2 3}
	editmode {select 0 "Equalised" 1 "Unequalised" 2 "Timing Equalised" 3 "TCM Adjusted"}
	storage none
	default 0
	display {
		if {[cgi auth role] ni {factory support}} {
			cgi return done
		} else {
			cgi set $field [readfile [root]/supervisory/modem[cgi get modem]/const_source]
			# display_field_help
		}
	}
	help "Source of the constellation data"
}

field samples {
	label "Sample Size"
	type {enum 5 20 100}
	default 5
	help "Number of packets to sample for the display"
	display {
		# display_field_help
	}
}

button refresh {
	label Update
	submit {
		writefile [root]/supervisory/modem[cgi get modem]/const_mode [cgi get mode]
		if {[cgi auth role] in {factory support}} {
			writefile [root]/supervisory/modem[cgi get modem]/const_source [cgi get source]
		}
	}
}
