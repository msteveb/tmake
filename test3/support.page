label "Support"
title "Technical Support"
summary "Support"

accesslevel admin

storage none

bar "Technical Support"

text {
	display {
		html str p "For technical support please contact:"

		html eval p {
			html puts "Web: "
			html str a href=http://emclarity.com.au/ emclarity.com.au
		}

		html eval p {
			html puts "Mail: "
			html str a href=mailto:support@emclarity.com.au support@emclarity.com.au
		}
	}
}

text {
	display {
		if {[cgi auth access $page] > 1} {
			html str p {
				The button below will download a detailed support report to your PC which
				may be sent to the technical support team to help resolve any issues.
			}
		}
	}
}

button support {
	label "Support Report"
	submit {
		set ok 0

		catch {
			set filename /tmp/support-report.txt

			# DOS format for all those Windows users
			exec support-report | sed -e "s/\$/\r/" >$filename

			set size [file size $filename]
			set f [open $filename]

			cgi nodisplay
			cgi http header Content-Length $size
			cgi http header Content-Type text/plain
			cgi http header Content-Disposition "attachment; filename=[file tail $filename]"
			cgi http response 200

			$f copyto stdout
			close $f

			set ok 1
		} error

		if {$ok} {
			cgi return done
		} else {
			cgi error "Failed to generate support report ($error)"
		}
	}
}

# vim: se ts=4:
